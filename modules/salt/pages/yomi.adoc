[[yomi.installer]]
= Install with Yomi

Yomi (yet one more installer) is an installer for openSUSE operating systems.
It is a SaltStack state, and can be used for installing Salt clients.

Yomi consists of two components:

* The Yomi formula, which contains the Salt states and modules required to drive the installation.
For the formula, see https://build.opensuse.org/package/show/systemsmanagement:yomi/yomi-formula.
* The LiveCD operating system image, which includes the `pre-configured ``salt-minion`` service.
For the image, see https://build.opensuse.org/package/show/systemsmanagement:yomi/openSUSE-Tumbleweed-Yomi


To use Yomi for installing your client operating system, you need to follow this process:

* Install and configure the ``salt-master``service.
* Install the Yomi formula package.
* Prepare the Salt pillar for the new installation.
* Boot the new systems with the operating system image, or use PXE boot.

For more information about using Yomi, see https://github.com/openSUSE/yomi/blob/master/README.md



== Install and Configure salt-master

You will require the ``salt-master`` service to be able to use Yomi for your client operating system.
If you have not yet installed it on the {productname} Server, you will need to do this step first.



.Procedure: Installing salt-master

. On the {productname} Server, at the command prompt, as root, install the ``salt-master`` service:
+
----
zypper in salt-master
----
. Use ``systemctl`` to enable the service:
+
----
systemctl enable --now salt-master.service
----

Yomi uses a Salt pillar to provide configuration information for the installation.
This can include the layout of the hard disks, the software
patterns to install, or the users to create.

By default, Salt searches for states in the [path]``/srv/salt/`` directory.
By default, Salt searches for pillars in [path]``/srv/pillar``.

You do not need to perform this step, if you are using the Yomi formula.


.Procedure: Configuring salt-master

. On the {productname} Server, at the command prompt, as root, create two new directories for the configuration file:
+
----
mkdir -p venv/etc/salt/pki/{master,minion}
----
.  Create two new virtual environments:
+
----
venv/etc/salt/autosign_grains
venv/var/cache/salt/master/file_lists/roots
----
. Add the configuration information to the new location:
+
----
cat <<EOF > venv/etc/salt/master
root_dir: $(pwd)/venv

file_roots:
  base:
    - $(pwd)/srv/salt

pillar_roots:
  base:
    - $(pwd)/srv/pillar
EOF
----



== Install the Yomi Formula Package


You can use the Yomi formula to install the states and modules you need.

The formula installs the states in [path]``/usr/share/salt-formulas/states``, and configuration files in [path]``/usr/share/yomi``.
It also stores some pillar examples in [path]``/usr/share/yomi/pillar``.

.Procedure: Installing the Yomi Formula

. On the {productname} Server, at the command prompt, as root, install the formula:
+
----
zypper in yomi-formula
----
. So that ``salt-master`` can find the pillar, change the
``pillar_roots`` entry in the configuration file, or use the one provided by the package:
+
----
cp -a /usr/share/yomi/pillar.conf /etc/salt/master.d/
----
. Restart services:
+
----
systemctl restart salt-master.service
----

== Prepare the Salt Pillar

The ``salt-api`` service is required so that Yomi can monitor the installation.

.Procedure: Preparing the Salt Pillar

. Enable this service:
+
----
cp /usr/share/yomi/salt-api.conf /etc/salt/master.d/
systemctl restart salt-master.service
----
. OPTIONAL: Open the [path]``/etc/salt/master.d/salt-api.conf`` configuration file, and add the required certificates to enable SSL.
. Open the pillar configuration file (location?) and add or edit these lines:
+
----
config:
  events: yes
----


When the pillar is configured, you can launch the ``monitor`` tool from the command prompt.
The `monitor` tool storez authentication tokens generated by Salt API in a local cache.
This makes future connections to the service simpler, but can sometimes can cause authentication errors.
If you start the ``monitor`` tool with the ``-r`` option, then the local cache is removed before the connection is made, which can avoid authentication problems.

Launch the ``monitor`` tool:
+
----
export SALTAPI_URL=http://localhost:8000
export SALTAPI_EAUTH=file
export SALTAPI_USER=salt
export SALTAPI_PASS=linux

monitor -r -y
----

[[WARNING]]
====
In this example, the password is in plain text.
Do not use this in a production environment.
====



== Boot Clients

Yomi is a set of Salt states that are used to drive the installation of a new operating system.
To take full control of the system where the installation will be done, you will need to boot from an external system that provides an already configured `salt-minion`, and a set of CLI tools required during the installation.

You can install YOMI on clients using different mechanisms.
There is a multi-build image available for download which provides a LiveCD ISO image, and a PXEÂ boot image.
You can download the image from https://build.opensuse.org/package/show/systemsmanagement:yomi/openSUSE-Tumbleweed-Yomi

This image is built from openSUSE Tumbleweed repositories.
It includes a very minimal set of tools, including the openSUSE version of `salt-minion`.

Alternatively, you can download the latest LiveCD image at the command prompt, using ``wget``:

----
wget https://download.opensuse.org/repositories/systemsmanagement:/yomi/images/iso/openSUSE-Tumbleweed-Yomi.x86_64-livecd.iso
----
